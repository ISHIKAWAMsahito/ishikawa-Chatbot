# セキュリティ脆弱性調査レポート

**対象**: `static`, `api`, `core`, `docs`, `models`, `services`  
**調査日**: 2025年2月9日（更新）

## 実施した修正 (AI_CONTEXT.md に準拠)

- **API認可**:
    - 管理者用API (`documents`, `system`, `stats`, `fallbacks`) に `require_auth` を付与。
    - 学生用API (`chat`, `feedback`, `history`) に `require_auth_client` を付与し、ログイン必須化。
    - WebSocket `/ws/settings` にトークン検証ロジックを追加。
- **セッション秘密鍵**: `core.config` で SECRET_KEY を定義し、本番環境での未設定時に起動失敗（Fail Fast）を実装。
- **Fail Fast**: `main.py` lifespan で必須環境変数（GEMINI_API_KEY, SUPABASE_URL等）の欠落をチェックし、即座に停止するよう修正。
- **Host ヘッダー検証**: `ALLOWED_HOSTS` による検証を導入。
- **SSL検証/SSRF対策**: スクレイピング時の `verify=True` 設定、URLスキーム制限を実施。
- **XSS対策**: `stats.html` に `DOMPurify` を導入し、marked出力のサニタイズを実施。他画面でもエスケープ処理を徹底。
- **入力検証**: `FeedbackCreate.comment` 等に `max_length` を設定。

---

## 1. 重大度: 高

### 1.1 API 認可の欠如（Broken Access Control）

**状態**: ✅ **修正済み**

- 全ての管理者向けAPIおよび学生向けAPIに対して、適切な `Depends` による認証ガードを実装済み。

---

### 1.2 セッション秘密鍵のデフォルト値

**状態**: ✅ **修正済み**

- 本番環境で `APP_SECRET_KEY` 未設定時にサーバーが起動しないよう修正済み。

---

### 1.3 Host ヘッダー信頼

**状態**: ✅ **修正済み**

- 許可されたホストリストに基づく検証ロジックを導入済み。

---

## 2. 重大度: 中

### 2.1 クロスサイトスクリプティング（XSS）

**状態**: ✅ **修正済み**

- AI分析結果のMarkdown表示において、`DOMPurify` によるサニタイズ処理を追加（`stats.html`）。

### 2.3 フィードバック API の認証・認可

**状態**: ✅ **修正済み**

- `/feedback` エンドポイントに `require_auth_client` を適用し、認証済みユーザーのみ投稿可能に修正。

---

## 3. 重大度: 低〜中

### 3.1 WebSocket の認証なし

**状態**: ✅ **修正済み**

- 管理者用WebSocket接続時にトークン検証を必須化。