# セキュリティ脆弱性調査レポート

**対象**: `static`, `api`, `core`, `docs`, `models`, `services`  
**調査日**: 2025年  

## 実施した修正 (AI_CONTEXT.md に準拠)

- **API認可**: documents GET（/all, /collections/..., /{id}）, system（config, collections, settings, gemini/status）, chat /analyze, feedback /stats に `require_auth` 付与。feedback POST に `require_auth_client` 付与。
- **セッション秘密鍵**: `core.config` で SECRET_KEY を定義し、本番（RENDER 設定時）では APP_SECRET_KEY 未設定時に起動失敗（Fail Fast）。
- **Host ヘッダー検証**: `core.config` に ALLOWED_HOSTS を追加し、`api/auth.py` の `get_safe_redirect_uri` で許可ホストのみ使用。
- **SSL検証**: `api/documents.py` のスクレイピングで `verify=True` に変更。
- **SSRF対策**: スクレイピング URL のスキームを https のみに制限し、ローカル・プライベート・メタデータホストを拒否。
- **エラーメッセージ**: 500 系で汎用メッセージを返却し、詳細は `logging.error(..., exc_info=True)` でログのみに記録。
- **検索サニタイズ**: `api/documents.py` で `_sanitize_search` を導入し、get_collection_documents の search もサニタイズ。
- **ChatQuery**: `question` に `max_length=4000`, `min_length=1` を設定。
- **XSS対策**: client.html / admin.html で `escapeHtml`, `isAllowedUrl` を導入し、チャット表示・ステータス・画像 URL をエスケープ/許可リスト化。stats.html で marked 出力から script と on* 属性を除去。
- **system/config**: `os.getenv` を廃止し、`core.config` の SUPABASE_URL, SUPABASE_ANON_KEY を使用。

---

## 1. 重大度: 高

### 1.1 API 認可の欠如（Broken Access Control）

| ファイル | エンドポイント | 問題 |
|----------|----------------|------|
| `api/documents.py` | `GET /api/admin/documents/all` | 認証なしでドキュメント一覧を取得可能 |
| `api/documents.py` | `GET /api/admin/documents/collections/{collection_name}/documents` | 認証なしでコレクション内ドキュメントを取得可能 |
| `api/documents.py` | `GET /api/admin/documents/{document_id}` | 認証なしで個別ドキュメントを取得可能 |
| `api/system.py` | `GET/POST /api/admin/system/*` 全般 | 設定取得・コレクション一覧・設定更新に認証がかかっていない |
| `api/chat.py` | `GET /api/client/analyze` | 認証なしでフィードバック分析を実行可能 |
| `api/feedback.py` | `GET /api/stats` | 認証なしでフィードバック統計を取得可能 |

**推奨**: 管理者向け API には `Depends(require_auth)` を付与する。学生向けチャットは `require_auth_client` などで「ログイン済み」を必須にする。

---

### 1.2 セッション秘密鍵のデフォルト値（Session Fixation / 偽造）

**ファイル**: `main.py`（72行付近）

```python
secret_key = os.getenv("APP_SECRET_KEY") or os.getenv("SECRET_KEY", "default-insecure-key")
```

本番で環境変数が未設定の場合、`default-insecure-key` が使われ、セッションの改ざん・偽造が可能になる。

**推奨**: 本番起動時に `APP_SECRET_KEY` が未設定なら起動を失敗させる（または強く警告する）。

---

### 1.3 Host ヘッダー信頼（Open Redirect / フィッシング）

**ファイル**: `api/auth.py`（25–29行付近）

```python
def get_safe_redirect_uri(request: Request, path: str) -> str:
    host = request.headers.get("host")
    ...
    return f"{scheme}://{host}{clean_path}"
```

`Host` ヘッダーをそのまま信頼しているため、攻撃者が `Host: evil.com` のように偽装すると、ログイン後のリダイレクト先を攻撃者サイトに誘導できる可能性がある。

**推奨**: 許可するホストのリスト（例: `ALLOWED_HOSTS`）を設定し、`host` がそのいずれかである場合のみ使用する。

---

### 1.4 SSL/TLS 検証の無効化（MITM リスク）

**ファイル**: `api/documents.py`（106行付近）

```python
async with httpx.AsyncClient(verify=False, headers=headers, ...) as client:
```

スクレイピングで TLS 証明書検証を無効にしているため、中間者攻撃で改ざんされたコンテンツを取り込むリスクがある。

**推奨**: `verify=True`（デフォルト）にし、必要な場合のみ証明書パスを明示的に指定する。

---

## 2. 重大度: 中

### 2.1 クロスサイトスクリプティング（XSS）

**2.1.1 チャット回答の表示（client.html / admin.html）**

- ストリーミングの `data.content` を `[text](url)` から `<a href="...">text</a>` に変換した `htmlText` をそのまま `innerHTML` に代入している。
- `text` 部分に `" onclick="..."` や `"><script>...` などが含まれると XSS になりうる。
- `data.status_message` もエスケープせず `innerHTML` に挿入している。

**2.1.2 addMessage（ユーザー/ボットメッセージ）**

- `text.includes('<a href=')` のとき、`processedText` をほぼそのまま `innerHTML` に渡している。
- RAG/LLM 出力に `<a href="..." onclick="...">` などが含まれると XSS の原因になる。

**2.1.3 統計・分析画面（stats.html）**

- `resultDiv.innerHTML = marked.parse(fullText)` で API から返った分析結果をそのまま表示している。
- `fullText` に HTML/JavaScript が含まれると XSS になる。

**2.1.4 画像モーダル（client.html / admin.html）**

- `content.innerHTML = '<img src="${imageUrl}" ...'` で `imageUrl` をそのまま挿入している。
- `imageUrl` が `javascript:...` などの場合、XSS になる。

**推奨**:
- ユーザー/LLM 由来の文字列は、表示用にエスケープする（例: テキストノードに代入する、または信頼できるサニタイザーを使用する）。
- `status_message` や `imageUrl` は許可リスト（例: `https:` のみ）・エスケープを施してから `innerHTML` に渡す。
- Markdown 表示は `marked` のオプションでサニタイズするか、出力をエスケープする。

---

### 2.2 スクレイピング URL の検証不足（SSRF / 危険スキーム）

**ファイル**: `api/documents.py`（`ScrapeRequest.url`）

- `request.url` をそのまま `client.get(request.url)` に渡している。
- `file://`, `http://localhost`, `http://169.254.169.254` などが許可されると、内部ネットワークやメタデータサービスへのアクセス（SSRF）やローカルファイル読み取りのリスクがある。

**推奨**: URL のスキームを `https`（必要なら `http` も許可リストで）に限定し、ホストを許可リストまたはブラックリストで検証する。

---

### 2.3 フィードバック API の認証・認可

**ファイル**: `api/feedback.py`

- `POST /api/` に認証がなく、誰でもフィードバックを送信できる。スパム・不正データの投入が可能。
- `GET /api/stats` に認証がなく、統計の取り放題になる（1.1 と重複）。

**推奨**: 投稿はレート制限や簡易認証（例: セッション必須）、統計は管理者認証必須とする。

---

### 2.4 エラーメッセージによる情報開示

**該当**: `api/documents.py`, `api/chat.py`, `api/fallbacks.py` など

- `HTTPException(500, detail=str(e))` や `detail=f"...{str(e)}"` により、内部例外メッセージがそのままクライアントに返る。
- スタックトレースやパス、DB 名などが漏れる可能性がある。

**推奨**: 本番では汎用メッセージ（例: 「処理に失敗しました」）を返し、詳細はログのみに記録する。

---

## 3. 重大度: 低〜中

### 3.1 WebSocket の認証なし

**ファイル**: `main.py`（`/ws/settings`）

- `/ws/settings` に認証がなく、誰でも接続して設定ブロードキャストを受け取れる。
- 設定内容が機密であれば情報開示のリスクになる。

**推奨**: WebSocket 接続時にセッションまたはトークンを検証し、管理者のみ許可する。

---

### 3.2 チャット入力の長さ制限なし

**ファイル**: `models/schemas.py`（`ChatQuery`）, `api/chat.py`

- `question` に Pydantic の `max_length` 等がなく、極端に長いクエリで API コスト増や DoS の可能性がある。

**推奨**: `Field(..., max_length=4000)` など、妥当な上限を設定する。

---

### 3.3 ドキュメント検索パラメータのサニタイズ

**ファイル**: `api/documents.py`

- `get_all_documents` では `search` を `replace(",", "").replace("%", "")` しているが、`get_collection_documents` の `search` は未サニタイズでクエリに渡している。
- Supabase の `ilike` で `%` や `_` による意図しないパターン一致の可能性がある。

**推奨**: 検索文字列は共通のサニタイズ関数でエスケープするか、パラメータ化された検索にする。

---

### 3.4 設定ファイル・フィードバックファイルのパス

**ファイル**: `core/settings.py`, `api/feedback.py`

- `shared_settings.json`, `feedback.json` を `BASE_DIR` 直下などに保存している。
- サーバーの設定次第では、パス traversal や上書きのリスクがあるため、保存先と権限の見直しが望ましい。

---

## 4. 対応優先度の目安

| 優先度 | 項目 |
|--------|------|
| 1 | 管理者 API への `require_auth` 付与（documents GET, system, chat analyze, feedback stats） |
| 2 | 本番でのセッション秘密鍵の必須化 |
| 3 | Host ヘッダーの検証（許可リスト） |
| 4 | スクレイピングの `verify=True` と URL スキーム/ホスト検証 |
| 5 | チャット・統計画面の XSS 対策（エスケープ・サニタイザー・画像 URL 検証） |
| 6 | エラーレスポンスの汎用化、WebSocket 認証、入力長制限 |

---

## 5. 実装について

**修正を実装する前に、必ず許可を取ってください。**  
個別の修正案（パッチ）が必要な場合は、どの項目から対応するか指定してください。
