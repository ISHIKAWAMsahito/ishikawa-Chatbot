<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚³ãƒ¼ãƒ‰ç®¡ç†ç”»é¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.98); 
            border-radius: 25px; 
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { 
            font-size: 2rem; 
            margin-bottom: 10px; 
        }
        .controls { 
            padding: 20px; 
            background: #f8f9fa; 
            display: flex; 
            gap: 20px; 
            flex-wrap: wrap; 
            align-items: center; 
        }
        .search-box { 
            flex: 1; 
            min-width: 300px; 
            padding: 10px; 
            border: 2px solid #e9ecef; 
            border-radius: 10px; 
            font-size: 16px; 
        }
        .btn { 
            padding: 10px 20px; 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s ease; 
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3); 
        }
        .btn.danger { 
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); 
        }
        .btn.secondary { 
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%); 
        }
        .table-container { 
            padding: 20px; 
            overflow-x: auto; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
        }
        #documentsTable { 
            /* åˆæœŸã¯éè¡¨ç¤ºã€‚JSã§è¡¨ç¤ºåˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚ */
            display: none;
        }
        th, td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #e9ecef; 
        }
        th { 
            background: #f8f9fa; 
            font-weight: 600; 
            color: #495057; 
            position: sticky; 
            top: 0; 
        }
        tr:hover { 
            background: #f1f3f5; 
        }
        .content-preview { 
            max-width: 400px; 
            max-height: 100px; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            font-size: 0.9rem; 
        }
        .metadata { 
            font-size: 0.85rem; 
            color: #6c757d; 
        }
        .action-buttons { 
            display: flex; 
            gap: 5px; 
        }
        .action-btn { 
            padding: 5px 10px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            transition: all 0.2s; 
        }
        .action-btn.edit { 
            background: #28a745; 
            color: white; 
        }
        .action-btn.delete { 
            background: #dc3545; 
            color: white; 
        }
        .action-btn:hover { 
            opacity: 0.8; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
        }
        .modal.show { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            width: 90%; 
            max-width: 800px; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        .modal-header { 
            margin-bottom: 20px; 
        }
        .modal-header h2 { 
            color: #333; 
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
        }
        .form-group textarea, .form-group input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            font-family: inherit; 
        }
        .form-group textarea { 
            min-height: 200px; 
            resize: vertical; 
        }
        .modal-footer { 
            display: flex; 
            gap: 10px; 
            justify-content: flex-end; 
            margin-top: 20px; 
        }
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #6c757d; 
        }
        .stats { 
            padding: 20px; 
            background: #e3f2fd; 
            border-radius: 10px; 
            margin: 20px; 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
        }
        .stat-card { 
            background: white; 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
        }
        .stat-number { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #4facfe; 
        }
        .stat-label { 
            color: #6c757d; 
            font-size: 0.9rem; 
        }
        .category-filter { 
            padding: 8px; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
        }

        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ã®ã¿è¡¨ç¤ºï¼ˆè¦–è¦šçš„ã«éè¡¨ç¤ºã«ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼‰*/
        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0 0 0 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ãƒ¬ã‚³ãƒ¼ãƒ‰ç®¡ç†ç”»é¢</h1>
            <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç®¡ç†</p>
        </div>

        <div class="stats">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="categoryCount">0</div>
                    <div class="stat-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selectedCount">0</div>
                    <div class="stat-label">é¸æŠä¸­</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="searchInput" class="search-box" placeholder="æ¤œç´¢ï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€ã‚½ãƒ¼ã‚¹ï¼‰">
            <!-- ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ: ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ï¼ˆç”»é¢ã«ã¯è¡¨ç¤ºã—ãªã„ sr-onlyï¼‰ã¨ aria-label ã‚’ä»˜ä¸ -->
            <label for="categoryFilter" class="sr-only">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§çµã‚Šè¾¼ã‚€</label>
            <select id="categoryFilter" class="category-filter" aria-label="ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§çµã‚Šè¾¼ã‚€">
                <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
            </select>
            <button class="btn" onclick="loadDocuments()">ğŸ”„ æ›´æ–°</button>
            <button class="btn secondary" onclick="window.location.href='/admin'">â† ç®¡ç†ç”»é¢ã«æˆ»ã‚‹</button>
        </div>

        <div class="table-container">
            <div id="loadingIndicator" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            <table id="documentsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                        <th>ã‚½ãƒ¼ã‚¹</th>
                        <th>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</th>
                        <th>ä½œæˆæ—¥æ™‚</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="documentsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ãƒ¬ã‚³ãƒ¼ãƒ‰ç·¨é›†</h2>
            </div>
            <div class="form-group">
                <label>ID:</label>
                <input type="text" id="editId" readonly>
            </div>
            <div class="form-group">
                <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼:</label>
                <input type="text" id="editCategory">
            </div>
            <div class="form-group">
                <label>ã‚½ãƒ¼ã‚¹:</label>
                <input type="text" id="editSource">
            </div>
            <div class="form-group">
                <label>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„:</label>
                <textarea id="editContent"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" onclick="saveDocument()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let allDocuments = [];
        let filteredDocuments = [];

        async function loadDocuments() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const table = document.getElementById('documentsTable');
            
            loadingIndicator.style.display = 'block';
            table.style.display = 'none';

            try {
                const response = await fetch('/api/documents/all');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allDocuments = data.documents || [];
                
                updateCategories();
                filterAndDisplayDocuments();
                updateStats();
                
                loadingIndicator.style.display = 'none';
                table.style.display = 'table';
            } catch (error) {
                console.error('Error loading documents:', error);
                loadingIndicator.innerHTML = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
        }

        function updateCategories() {
            const categories = new Set();
            allDocuments.forEach(doc => {
                if (doc.metadata?.category) {
                    categories.add(doc.metadata.category);
                }
            });

            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>';
            Array.from(categories).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        function filterAndDisplayDocuments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredDocuments = allDocuments.filter(doc => {
                const matchesSearch = !searchTerm || 
                    doc.content.toLowerCase().includes(searchTerm) ||
                    (doc.metadata?.category || '').toLowerCase().includes(searchTerm) ||
                    (doc.metadata?.source || '').toLowerCase().includes(searchTerm);

                const matchesCategory = !categoryFilter || 
                    doc.metadata?.category === categoryFilter;

                return matchesSearch && matchesCategory;
            });

            displayDocuments(filteredDocuments);
            updateStats();
        }

        function displayDocuments(documents) {
            const tbody = document.getElementById('documentsBody');
            tbody.innerHTML = '';

            documents.slice(0, 100).forEach(doc => {
                const tr = document.createElement('tr');
                const created = doc.created_at ? new Date(doc.created_at).toLocaleString('ja-JP') : 'N/A';
                
                tr.innerHTML = `
                    <td>${doc.id}</td>
                    <td><span class="metadata">${doc.metadata?.category || 'ãã®ä»–'}</span></td>
                    <td><span class="metadata">${doc.metadata?.source || 'N/A'}</span></td>
                    <td><div class="content-preview">${escapeHtml(doc.content)}</div></td>
                    <td><span class="metadata">${created}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editDocument(${doc.id})">ç·¨é›†</button>
                            <button class="action-btn delete" onclick="deleteDocument(${doc.id})">å‰Šé™¤</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = allDocuments.length;
            
            const categories = new Set();
            allDocuments.forEach(doc => {
                if (doc.metadata?.category) {
                    categories.add(doc.metadata.category);
                }
            });
            document.getElementById('categoryCount').textContent = categories.size;
            
            document.getElementById('selectedCount').textContent = filteredDocuments.length;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function editDocument(id) {
            const doc = allDocuments.find(d => d.id === id);
            if (!doc) return;

            document.getElementById('editId').value = doc.id;
            document.getElementById('editCategory').value = doc.metadata?.category || '';
            document.getElementById('editSource').value = doc.metadata?.source || '';
            document.getElementById('editContent').value = doc.content;

            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function saveDocument() {
            const id = document.getElementById('editId').value;
            const category = document.getElementById('editCategory').value;
            const source = document.getElementById('editSource').value;
            const content = document.getElementById('editContent').value;

            try {
                const doc = allDocuments.find(d => d.id == id);
                const updatedMetadata = {
                    ...doc.metadata,
                    category: category,
                    source: source
                };

                const response = await fetch(`/api/documents/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        metadata: updatedMetadata
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                alert('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                closeEditModal();
                loadDocuments();
            } catch (error) {
                console.error('Error saving document:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function deleteDocument(id) {
            if (!confirm(`ID ${id} ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/documents/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                alert('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                loadDocuments();
            } catch (error) {
                console.error('Error deleting document:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('searchInput').addEventListener('input', filterAndDisplayDocuments);
        document.getElementById('categoryFilter').addEventListener('change', filterAndDisplayDocuments);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // åˆæœŸèª­ã¿è¾¼ã¿
        loadDocuments();
    </script>
</body>
</html>