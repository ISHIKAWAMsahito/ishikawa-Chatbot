<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI chatbot systemã€çµ±è¨ˆãƒ»ç›¸è«‡ã€‘</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
<style>
    /* --- åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ (admin.htmlã¨å…±é€š) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 24px;
        color: #333;
    }
    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 16px;
        box-shadow: 0 32px 64px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        min-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px 30px;
        text-align: center;
        position: relative;
        flex-shrink: 0;
    }
    .header h1 { margin-bottom: 5px; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); font-size: 1.8rem; }
    .header p { font-size: 0.9rem; opacity: 0.9; }
    
    .nav-btn {
        position: absolute;
        top: 25px;
        padding: 8px 20px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: bold;
        font-size: 0.85rem;
        background-color: white; 
        color: #333; 
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .nav-btn:hover { background-color: #f0f0f0; transform: translateY(-1px); }
    .logout-btn { right: 25px; }
    .admin-link-btn { left: 25px; }

    /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .dashboard-content { 
        padding: 32px; 
        display: grid; 
        grid-template-columns: 1fr 400px; /* å³å´ã‚’å°‘ã—åºƒã’ã¾ã—ãŸ */
        gap: 32px; 
        flex-grow: 1;
    }
    
    /* ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    .card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-left: 5px solid #4facfe;
        text-align: center;
    }
    .card h3 { font-size: 0.85rem; color: #666; margin-bottom: 8px; }
    .card .value { font-size: 1.8rem; font-weight: bold; color: #333; }
    .card .sub { font-size: 0.75rem; color: #888; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒªã‚¢ */
    .table-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        overflow-x: auto;
    }
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }
    .section-header h2 { font-size: 1.2rem; color: #444; }
    table { width: 100%; border-collapse: collapse; min-width: 500px; }
    th { text-align: left; padding: 10px; background: #f8f9fa; color: #555; font-weight: 600; border-bottom: 2px solid #eee; font-size: 0.9rem; }
    td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; vertical-align: top; }
    .col-date { width: 140px; color: #888; font-size: 0.8rem; }
    .col-rating { width: 100px; text-align: center; }
    
    /* å³ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
    .sidebar { display: flex; flex-direction: column; gap: 24px; height: 100%; }
    .panel-box {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* --- ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆé¢¨ UI (Consultation) --- */
    .chat-panel {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’åŸ‹ã‚ã‚‹ */
        min-height: 400px;
        border: 2px solid #e0e7ff;
    }
    .chat-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }
    .chat-header h3 { font-size: 1.1rem; color: #4facfe; display: flex; align-items: center; gap: 8px; }
    
    .chat-history {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        background: #f9faff;
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-height: 500px;
    }
    
    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ« */
    .message {
        max-width: 90%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 0.9rem;
        line-height: 1.5;
        position: relative;
    }
    .message.user {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 2px;
    }
    .message.ai {
        align-self: flex-start;
        background: white;
        color: #333;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 2px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .message.ai strong { color: #d63384; } /* é‡è¦ç®‡æ‰€ã‚’å¼·èª¿ */
    .message.ai ul { padding-left: 20px; margin: 5px 0; }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-area {
        display: flex;
        gap: 10px;
    }
    .input-area textarea {
        flex-grow: 1;
        resize: none;
        height: 50px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-family: inherit;
    }
    .input-area button {
        width: 60px;
        background: #4facfe;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .input-area button:hover { background: #00f2fe; }
    .input-area button:disabled { background: #ccc; cursor: not-allowed; }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 1000px) {
        .dashboard-content { grid-template-columns: 1fr; }
        .stats-cards { grid-template-columns: 1fr; }
        .chat-panel { height: 500px; }
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/admin.html" class="nav-btn admin-link-btn">â¬… ç®¡ç†ç”»é¢ã¸æˆ»ã‚‹</a>
            <a href="/logout" class="nav-btn logout-btn">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            <h1>ğŸ“Š çµ±è¨ˆãƒ»æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</h1>
            <p>å­¦ç”Ÿã®å£°ã®åˆ†æã¨ã€AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®æ”¹å–„ç›¸è«‡</p>
        </div>

        <div class="dashboard-content">
            <div class="main-area">
                <div class="stats-cards">
                    <div class="card">
                        <h3>ğŸ“ ç·ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ•°</h3>
                        <div class="value" id="totalCount">-</div>
                        <div class="sub">å…¨æœŸé–“ã®ç´¯è¨ˆ</div>
                    </div>
                    <div class="card">
                        <h3>ğŸ‘ é«˜è©•ä¾¡ç‡</h3>
                        <div class="value" id="goodRate">-</div>
                        <div class="sub" id="goodCountSub">Good: 0 / Bad: 0</div>
                    </div>
                    <div class="card">
                        <h3>ğŸ“… ä»Šé€±ã®åˆ©ç”¨</h3>
                        <div class="value" id="weeklyCount">-</div>
                        <div class="sub">éå»7æ—¥é–“</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="section-header">
                        <h2>ğŸ“‹ æœ€æ–°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å±¥æ­´</h2>
                        <button class="small-btn" onclick="fetchData()" style="padding:6px 12px; cursor:pointer; background:#f0f0f0; border:1px solid #ccc; border-radius:4px;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th class="col-date">æ—¥æ™‚</th>
                                <th class="col-rating">è©•ä¾¡</th>
                                <th class="col-log">ä¼šè©±ãƒ­ã‚° / ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr><td colspan="3" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel-box">
                    <h3>ğŸ“ˆ è©•ä¾¡ã®å‰²åˆ</h3>
                    <canvas id="ratingChart"></canvas>
                </div>

                <div class="panel-box chat-panel">
                    <div class="chat-header">
                        <h3>ğŸ¤– AIæ¥­å‹™æ”¹å–„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</h3>
                        <p style="font-size:0.8rem; color:#888;">è“„ç©ã•ã‚ŒãŸãƒ­ã‚°ã‚’åŸºã«ã€æ”¹å–„æ¡ˆã‚’ç›¸è«‡ã§ãã¾ã™ã€‚</p>
                    </div>
                    
                    <div id="chatHistory" class="chat-history">
                        <div class="message ai">
                            ã“ã‚“ã«ã¡ã¯ã€‚å­¦ç”Ÿå¯¾å¿œãƒ­ã‚°ã®åˆ†ææ‹…å½“ã§ã™ã€‚<br>
                            ã€Œæœ€è¿‘ã®1å¹´ç”Ÿã®æ‚©ã¿ã¯ï¼Ÿã€ã‚„ã€Œå±¥ä¿®ç™»éŒ²ã®FAQã«ä¸è¶³ã¯ãªã„ï¼Ÿã€ãªã©ã€ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <textarea id="queryInput" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." onkeydown="handleEnter(event)"></textarea>
                        <button id="sendBtn" onclick="sendConsultation()">é€ä¿¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    let chartInstance = null;

    // --- 1. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¡¨ç¤º (æ—¢å­˜æ©Ÿèƒ½) ---
    async function fetchData() {
        try {
            const response = await fetch('/api/admin/stats/data');
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }

            const data = await response.json();
            renderDashboard(data);

        } catch (err) {
            console.error("Fetch error:", err);
            document.getElementById('dataTableBody').innerHTML = `<tr><td colspan="3" style="color:red; text-align:center;">ã‚¨ãƒ©ãƒ¼: ${err.message}</td></tr>`;
        }
    }

    function renderDashboard(data) {
        const total = data.length;
        const good = data.filter(i => i.rating === 'good').length;
        const bad = data.filter(i => i.rating === 'bad').length;
        const rate = total > 0 ? Math.round((good / total) * 100) : 0;

        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const weekly = data.filter(i => new Date(i.created_at) > oneWeekAgo).length;

        document.getElementById('totalCount').textContent = total + "ä»¶"; 
        document.getElementById('goodRate').textContent = rate + "%";
        document.getElementById('goodCountSub').textContent = `Good: ${good} / Bad: ${bad}`;
        document.getElementById('weeklyCount').textContent = weekly + "ä»¶";

        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        } else {
            data.forEach(item => {
                const tr = document.createElement('tr');
                const date = new Date(item.created_at).toLocaleString('ja-JP');
                
                const tdDate = document.createElement('td');
                tdDate.className = 'col-date';
                tdDate.textContent = date;

                const tdRating = document.createElement('td');
                tdRating.className = 'col-rating';
                tdRating.innerHTML = item.rating === 'good' 
                    ? '<span style="color:#28a745">ğŸ‘ Good</span>' 
                    : '<span style="color:#dc3545">ğŸ‘ Bad</span>';

                const tdLog = document.createElement('td');
                tdLog.className = 'col-log';
                tdLog.textContent = item.comment || item.content || "(ãƒ­ã‚°ãªã—)"; // XSSå¯¾ç­–

                tr.appendChild(tdDate);
                tr.appendChild(tdRating);
                tr.appendChild(tdLog);
                tbody.appendChild(tr);
            });
        }
        renderChart(good, bad);
    }

    function renderChart(good, bad) {
        const ctx = document.getElementById('ratingChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Good (é«˜è©•ä¾¡)', 'Bad (ä½è©•ä¾¡)'],
                datasets: [{
                    data: [good, bad],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // --- 2. AIç›¸è«‡ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ (æ–°è¦å®Ÿè£…) ---
    
    // Enterã‚­ãƒ¼é€ä¿¡å¯¾å¿œ
    function handleEnter(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendConsultation();
        }
    }

    async function sendConsultation() {
        const input = document.getElementById('queryInput');
        const btn = document.getElementById('sendBtn');
        const history = document.getElementById('chatHistory');
        const query = input.value.trim();

        if (!query) return;

        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        appendMessage('user', query);
        input.value = '';
        btn.disabled = true;

        // 2. AIã®ç©ºãƒãƒ–ãƒ«ã‚’ä½œæˆï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼‰
        const aiBubbleId = 'ai-' + Date.now();
        appendMessage('ai', '<span id="' + aiBubbleId + '">è€ƒãˆä¸­...</span>');
        
        try {
            // APIå‘¼ã³å‡ºã— (Step 4ã§ä½œæˆã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)
            // api/stats.py ãŒ /api/admin/stats ã«ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®š
            const response = await fetch('/api/admin/stats/chat_analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    query: query,
                    target_period_days: 30 // éå»30æ—¥åˆ†ã‚’åˆ†æå¯¾è±¡ã¨ã™ã‚‹
                })
            });

            if (!response.ok) throw new Error("API Error: " + response.statusText);

            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let aiResponseText = "";
            const bubbleContent = document.getElementById(aiBubbleId);

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                // APIã®å®Ÿè£…ã«ã‚ˆã‚Š "data: " ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒã‚ã‚‹å ´åˆã¨ãªã„å ´åˆã«å¯¾å¿œ
                // ä»Šå›ã®å®Ÿè£…ã§ã¯ raw text ãŒè¿”ã£ã¦ãã‚‹æƒ³å®šã ãŒã€å¿µã®ãŸã‚æ•´å½¢
                aiResponseText += chunk;
                
                // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¤‰æ›ã—ã¦è¡¨ç¤ºæ›´æ–°
                bubbleContent.innerHTML = DOMPurify.sanitize(marked.parse(aiResponseText));
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¿½å¾“
                history.scrollTop = history.scrollHeight;
            }

        } catch (error) {
            console.error(error);
            const bubbleContent = document.getElementById(aiBubbleId);
            if(bubbleContent) bubbleContent.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message;
        } finally {
            btn.disabled = false;
            input.focus();
        }
    }

    function appendMessage(role, htmlContent) {
        const history = document.getElementById('chatHistory');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        
        if (role === 'user') {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¯ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æ‰±ã†ï¼ˆXSSå¯¾ç­–ï¼‰
            div.textContent = htmlContent;
        } else {
            // AIå›ç­”ã¯HTMLï¼ˆMarkdownå¤‰æ›å¾Œï¼‰ã¨ã—ã¦æ‰±ã†
            div.innerHTML = htmlContent;
        }
        
        history.appendChild(div);
        history.scrollTop = history.scrollHeight;
    }

    // åˆæœŸåŒ–
    fetchData();
    </script>
</body>
</html>