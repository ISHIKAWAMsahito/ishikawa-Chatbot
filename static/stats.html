<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI chatbot systemã€çµ±è¨ˆãƒ»åˆ†æã€‘</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
<style>
    /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (admin.htmlã¨å…±é€š) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 24px;
        color: #333;
    }
    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 16px;
        box-shadow: 0 32px 64px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        min-height: 80vh;
    }
    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
    }
    .header h1 { margin-bottom: 10px; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); }
    
     .nav-btn { /*ç®¡ç†ç”»é¢ã¸æˆ»ã‚‹ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®èƒŒæ™¯ã‚’ç™½ã€æ–‡å­—ã‚’é»’ã«å¤‰æ›´ */
        position: absolute;
        top: 25px;
        padding: 10px 24px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: bold;
        font-size: 0.95rem;
        
        /* â–¼ ã“ã“ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼ˆèƒŒæ™¯ç™½ã€æ–‡å­—é»’ï¼‰ */
        background-color: white; 
        color: #333; 
        /* â–² å¤‰æ›´ã“ã“ã¾ã§ */

        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.4); /* æ ç·šãŒä¸è¦ãªã‚‰ã“ã®è¡Œã‚’å‰Šé™¤ */
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* ç™½èƒŒæ™¯ãªã®ã§å°‘ã—å½±ã‚’ã¤ã‘ã‚‹ã¨è¦‹ã‚„ã™ã„ã§ã™ */
    }
    .nav-btn:hover { background-color: white; color: #667eea; }
    .logout-btn { right: 25px; }
    .admin-link-btn { left: 25px; }

    /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .dashboard-content { padding: 32px; display: grid; grid-template-columns: 1fr 350px; gap: 32px; }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    .card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-left: 5px solid #4facfe;
        text-align: center;
    }
    .card h3 { font-size: 0.9rem; color: #666; margin-bottom: 8px; }
    .card .value { font-size: 2rem; font-weight: bold; color: #333; }
    .card .sub { font-size: 0.8rem; color: #888; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒªã‚¢ */
    .table-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        overflow-x: auto;
    }
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: left; padding: 12px; background: #f8f9fa; color: #555; font-weight: 600; border-bottom: 2px solid #eee; }
    td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95rem; vertical-align: top; }
    .col-date { width: 150px; color: #888; font-size: 0.85rem; }
    .col-rating { width: 100px; text-align: center; font-size: 1.2rem; }
    .col-log { color: #444; white-space: pre-wrap; word-break: break-all; }
    
    /* å³ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆã‚°ãƒ©ãƒ•ãƒ»AIåˆ†æï¼‰ */
    .sidebar { display: flex; flex-direction: column; gap: 24px; }
    .panel-box {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    /* AIåˆ†æãƒœã‚¿ãƒ³ */
    .analyze-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        justify-content: center;
        gap: 8px;
        align-items: center;
        margin-bottom: 15px;
    }
    .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4); }
    .analyze-btn:disabled { opacity: 0.6; cursor: wait; }
    
    .ai-result {
        background: #f0f8ff;
        padding: 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        line-height: 1.6;
        min-height: 100px;
        border: 1px dashed #4facfe;
    }
    .ai-result h3 { font-size: 1rem; margin-top: 10px; margin-bottom: 5px; color: #333; }
    .ai-result ul { padding-left: 20px; margin-bottom: 10px; }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 1000px) {
        .dashboard-content { grid-template-columns: 1fr; }
        .stats-cards { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/admin.html" class="nav-btn admin-link-btn">â¬… ç®¡ç†ç”»é¢ã¸æˆ»ã‚‹</a>
            <a href="/logout" class="nav-btn logout-btn">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            <h1>ğŸ“Š çµ±è¨ˆãƒ»åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨å‚¾å‘åˆ†æ</p>
        </div>

        <div class="dashboard-content">
            <div class="main-area">
                <div class="stats-cards">
                    <div class="card">
                        <h3>ğŸ“ ç·ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ•°</h3>
                        <div class="value" id="totalCount">-</div>
                        <div class="sub">å…¨æœŸé–“ã®ç´¯è¨ˆ</div>
                    </div>
                    <div class="card">
                        <h3>ğŸ‘ é«˜è©•ä¾¡ç‡</h3>
                        <div class="value" id="goodRate">-</div>
                        <div class="sub" id="goodCountSub">Good: 0 / Bad: 0</div>
                    </div>
                    <div class="card">
                        <h3>ğŸ“… ä»Šé€±ã®åˆ©ç”¨</h3>
                        <div class="value" id="weeklyCount">-</div>
                        <div class="sub">éå»7æ—¥é–“</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="section-header">
                        <h2>ğŸ“‹ æœ€æ–°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å±¥æ­´</h2>
                        <button class="small-btn primary" onclick="fetchData()" style="padding:6px 12px; cursor:pointer;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th class="col-date">æ—¥æ™‚</th>
                                <th class="col-rating">è©•ä¾¡</th>
                                <th class="col-log">ä¼šè©±ãƒ­ã‚° / ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr><td colspan="3" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel-box">
                    <h3>ğŸ“ˆ è©•ä¾¡ã®å‰²åˆ</h3>
                    <canvas id="ratingChart"></canvas>
                </div>

                <div class="panel-box">
                    <h3>ğŸ§  AIå‚¾å‘åˆ†æ</h3>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">
                        ä¼šè©±ãƒ­ã‚°ã®å†…å®¹ã‚’AIãŒèª­ã¿å–ã‚Šã€è³ªå•ã®å‚¾å‘ã‚„æ”¹å–„ç‚¹ã‚’åˆ†æã—ã¾ã™ã€‚
                    </p>
                    <button class="analyze-btn" id="analyzeBtn" onclick="runAiAnalysis()">
                        <span>âœ¨ åˆ†æã‚’å®Ÿè¡Œã™ã‚‹</span>
                    </button>
                    <div id="aiAnalysisResult" class="ai-result">
                        ã“ã“ã«åˆ†æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const { createClient } = supabase;
    let supabaseClient = null;
    let chartInstance = null;
    let currentData = [];

    // SupabaseåˆæœŸåŒ–
    async function initializeSupabase() {
        try {
            const response = await fetch('/api/client/chat/config');
            if (!response.ok) return;
            const config = await response.json();
            if (config.supabase_url && config.supabase_anon_key) {
                supabaseClient = createClient(config.supabase_url, config.supabase_anon_key);
                console.log('Supabase initialized');
                fetchData();
            }
        } catch (error) {
            console.error("Supabase init error:", error);
        }
    }

    // ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
    async function fetchData() {
        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ä½¿ã‚ãšã€è‡ªã‚µãƒ¼ãƒãƒ¼ã®APIã‚’å©ã
        try {
            const response = await fetch('/api/admin/stats/data');
            
            if (!response.ok) {
                // èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ï¼‰ãªã©ã®å ´åˆ
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login'; // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é£›ã°ã™
                    return;
                }
                throw new Error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }

            const data = await response.json();
            currentData = data;
            renderDashboard(data);

        } catch (err) {
            console.error("Fetch error:", err);
            // Snykå¯¾ç­– (CWE-79): innerHTMLã¸ã®å¤‰æ•°å±•é–‹ã‚’é¿ã‘ã€textContentã‚’ä½¿ç”¨
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = ''; // ã‚¯ãƒªã‚¢
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 3;
            td.style.color = 'red';
            td.style.textAlign = 'center';
            td.textContent = `ã‚¨ãƒ©ãƒ¼: ${err.message}`;
            tr.appendChild(td);
            tbody.appendChild(tr);
        }
    }

    // ç”»é¢æç”»
    // ç”»é¢æç”»
    function renderDashboard(data) {
        // KPIè¨ˆç®—
        const total = data.length;
        const good = data.filter(i => i.rating === 'good').length;
        const bad = data.filter(i => i.rating === 'bad').length;
        const rate = total > 0 ? Math.round((good / total) * 100) : 0;

        // ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const weekly = data.filter(i => new Date(i.created_at) > oneWeekAgo).length;

        document.getElementById('totalCount').textContent = total + "ä»¶"; 
        document.getElementById('goodRate').textContent = rate + "%";
        document.getElementById('goodCountSub').textContent = `Good: ${good} / Bad: ${bad}`;
        document.getElementById('weeklyCount').textContent = weekly + "ä»¶";

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆSnykå¯¾ç­–: innerHTMLã‚’ä½¿ã‚ãšDOMæ§‹ç¯‰ï¼‰
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 3;
            td.style.textAlign = 'center';
            td.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
            tr.appendChild(td);
            tbody.appendChild(tr);
        } else {
            data.forEach(item => {
                const tr = document.createElement('tr');
                const date = new Date(item.created_at).toLocaleString('ja-JP');
                
                // æ—¥æ™‚
                const tdDate = document.createElement('td');
                tdDate.className = 'col-date';
                tdDate.textContent = date;
                tr.appendChild(tdDate);

                // è©•ä¾¡
                const tdRating = document.createElement('td');
                tdRating.className = 'col-rating';
                const spanRating = document.createElement('span');
                if (item.rating === 'good') {
                    spanRating.style.color = '#28a745';
                    spanRating.textContent = 'ğŸ‘ Good';
                } else {
                    spanRating.style.color = '#dc3545';
                    spanRating.textContent = 'ğŸ‘ Bad';
                }
                tdRating.appendChild(spanRating);
                tr.appendChild(tdRating);

                // ãƒ­ã‚°/ã‚³ãƒ¡ãƒ³ãƒˆ
                const tdLog = document.createElement('td');
                tdLog.className = 'col-log';
                // user input (comment) ã‚’ textContent ã§ã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ã§XSSã‚’å®Œå…¨ç„¡åŠ¹åŒ–
                tdLog.textContent = item.comment || "(ãƒ­ã‚°ãªã—)";
                tr.appendChild(tdLog);

                tbody.appendChild(tr);
            });
        }

        // ã‚°ãƒ©ãƒ•æç”»
        renderChart(good, bad);
    }

    function renderChart(good, bad) {
        const ctx = document.getElementById('ratingChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Good (é«˜è©•ä¾¡)', 'Bad (ä½è©•ä¾¡)'],
                datasets: [{
                    data: [good, bad],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // AIåˆ†æã®å®Ÿè¡Œ
    async function runAiAnalysis() {
        const btn = document.getElementById('analyzeBtn');
        const resultDiv = document.getElementById('aiAnalysisResult');
        
        if (currentData.length === 0) {
            resultDiv.textContent = "åˆ†æã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
            return;
        }

        // UIæ›´æ–°ï¼ˆãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ãƒ»ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºï¼‰
        btn.disabled = true;
        btn.innerHTML = '<span>â³ åˆ†æä¸­...</span>';
        resultDiv.textContent = "GeminiãŒãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™...";

        try {
            // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const response = await fetch('/api/admin/chat/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ãƒ»åˆ†æã™ã‚‹ä»•æ§˜ã®ãŸã‚ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é€ä¿¡
                body: JSON.stringify({}) 
            });

            if (!response.ok) throw new Error("API Error");

            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®èª­ã¿è¾¼ã¿å‡¦ç†
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(line.substring(6));
                            if (json.content) fullText += json.content;
                        } catch(e){}
                    }
                }
            }

            // â–¼â–¼â–¼ Snykå¯¾ç­– (CWE-79) ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ â–¼â–¼â–¼
            // æ­£è¦è¡¨ç¾(.replace)ã§ã¯ãªãã€DOMPurify.sanitize()ã‚’ä½¿ç”¨ã™ã‚‹
            const rawHtml = marked.parse(fullText || '');
            const cleanHtml = DOMPurify.sanitize(rawHtml);
            
            resultDiv.innerHTML = cleanHtml;
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

        } catch (error) {
            console.error(error);
            resultDiv.textContent = "åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        } finally {
            // UIå¾©å¸°
            btn.disabled = false;
            btn.innerHTML = '<span>âœ¨ åˆ†æã‚’å®Ÿè¡Œã™ã‚‹</span>';
        }
    }

    function escapeHtml(str) {
        if(!str) return '';
        return str.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            }[m];
        });
    }

    // å®Ÿè¡Œ
    initializeSupabase();
    </script>
</body>
</html>