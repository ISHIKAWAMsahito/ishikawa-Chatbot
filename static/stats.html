<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI chatbot systemã€çµ±è¨ˆãƒ»æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã€‘</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 24px;
    color: #333;
}

.container {
    max-width: 1500px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.98);
    border-radius: 20px;
    box-shadow: 0 32px 64px rgba(0, 0, 0, 0.18);
    overflow: hidden;
    min-height: 90vh;
    display: flex;
    flex-direction: column;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 28px 32px;
    text-align: center;
    position: relative;
}
.header h1 { font-size: 1.9rem; font-weight: 700; text-shadow: 1px 2px 8px rgba(0,0,0,0.25); }
.header p  { font-size: 0.9rem; opacity: 0.88; margin-top: 4px; }

.nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    padding: 8px 18px;
    border-radius: 30px;
    text-decoration: none;
    font-weight: 700;
    font-size: 0.85rem;
    background: rgba(255,255,255,0.95);
    color: #444;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: all 0.2s;
}
.nav-btn:hover { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: translateY(calc(-50% - 2px)); }
.nav-btn.left  { left: 24px; }
.nav-btn.right { right: 24px; }

/* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æœ¬ä½“ */
.dashboard {
    display: grid;
    grid-template-columns: 1fr 480px;
    gap: 28px;
    padding: 28px;
    flex-grow: 1;
    min-height: 0;
}

/* --- KPIã‚«ãƒ¼ãƒ‰ --- */
.kpi-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}
.kpi-card {
    background: #fff;
    border-radius: 14px;
    padding: 18px 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
    border-top: 4px solid #667eea;
    transition: transform 0.2s;
}
.kpi-card:hover { transform: translateY(-3px); }
.kpi-card.green  { border-top-color: #28a745; }
.kpi-card.blue   { border-top-color: #17a2b8; }
.kpi-card.orange { border-top-color: #fd7e14; }
.kpi-card h3 { font-size: 0.78rem; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
.kpi-card .val { font-size: 2rem; font-weight: 800; color: #333; margin: 4px 0; }
.kpi-card .sub { font-size: 0.75rem; color: #aaa; }

/* --- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ãƒ¼ãƒ–ãƒ« --- */
.table-box {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
    overflow: hidden;
}
.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #f0f0f0;
}
.table-header h2 { font-size: 1rem; font-weight: 700; color: #444; }
.refresh-btn {
    padding: 6px 14px;
    background: #f0f4ff;
    color: #667eea;
    border: 1px solid #c5cff7;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s;
}
.refresh-btn:hover { background: #e0e8ff; }

.table-scroll { overflow-x: auto; max-height: 340px; overflow-y: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    color: #555;
    border-bottom: 2px solid #eee;
    white-space: nowrap;
}
td { padding: 10px 14px; border-bottom: 1px solid #f3f3f3; vertical-align: top; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: #fafbff; }
.badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
}
.badge.good { background: #d4edda; color: #155724; }
.badge.bad  { background: #f8d7da; color: #721c24; }

/* =====================================================
   å³ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«: AIç›¸è«‡ãƒãƒ£ãƒƒãƒˆ
   ===================================================== */
.sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-height: 0;
}

/* ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ */
.vec-status-card {
    background: #fff;
    border-radius: 14px;
    padding: 16px 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
    border-left: 5px solid #4facfe;
}
.vec-status-card h3 { font-size: 0.9rem; font-weight: 700; color: #444; margin-bottom: 10px; }
.vec-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.82rem;
    margin-bottom: 6px;
}
.vec-row .label { color: #666; }
.vec-row .nums  { font-weight: 700; }
.progress-bar {
    height: 6px;
    background: #eee;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 4px;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4facfe, #00f2fe);
    border-radius: 3px;
    transition: width 0.5s ease;
}
.vec-actions { display: flex; gap: 8px; margin-top: 12px; }
.vec-btn {
    flex: 1;
    padding: 7px 10px;
    border: none;
    border-radius: 8px;
    font-size: 0.82rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
}
.vec-btn.primary { background: linear-gradient(135deg,#4facfe,#00f2fe); color: white; }
.vec-btn.primary:hover { opacity: 0.88; }
.vec-btn.secondary { background: #f0f4ff; color: #667eea; border: 1px solid #c5cff7; }
.vec-btn.secondary:hover { background: #e0e8ff; }
.vec-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ« */
.chat-panel {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-height: 0;
    border: 2px solid #e8edff;
    overflow: hidden;
}
.chat-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid #f0f0f0;
    flex-shrink: 0;
}
.chat-panel-header h3 {
    font-size: 1rem;
    font-weight: 700;
    color: #444;
    display: flex;
    align-items: center;
    gap: 8px;
}
.chat-panel-header p { font-size: 0.78rem; color: #999; margin-top: 3px; }

/* ä¾‹ç¤ºã‚¯ã‚¨ãƒª */
.example-queries {
    padding: 12px 16px;
    border-bottom: 1px solid #f5f5f5;
    flex-shrink: 0;
}
.example-queries p { font-size: 0.75rem; color: #aaa; margin-bottom: 6px; font-weight: 600; }
.ex-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.ex-chip {
    padding: 4px 10px;
    background: #f0f4ff;
    border: 1px solid #d0daff;
    border-radius: 20px;
    font-size: 0.75rem;
    color: #667eea;
    cursor: pointer;
    transition: all 0.18s;
    font-weight: 600;
}
.ex-chip:hover { background: #e0e8ff; border-color: #667eea; }

/* ä¼šè©±å±¥æ­´ */
.chat-history {
    flex-grow: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    background: #fafbff;
    min-height: 0;
}
.msg {
    max-width: 92%;
    padding: 10px 14px;
    border-radius: 14px;
    font-size: 0.88rem;
    line-height: 1.65;
    animation: fadeUp 0.25s ease;
}
@keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

.msg.user {
    align-self: flex-end;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-bottom-right-radius: 3px;
}
.msg.ai {
    align-self: flex-start;
    background: white;
    color: #333;
    border: 1px solid #e8e8e8;
    border-bottom-left-radius: 3px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}
/* Markdownã‚¹ã‚¿ã‚¤ãƒ« */
.msg.ai h1,.msg.ai h2,.msg.ai h3 { margin: 8px 0 4px; color: #444; }
.msg.ai ul,.msg.ai ol { padding-left: 18px; margin: 5px 0; }
.msg.ai li { margin: 2px 0; }
.msg.ai strong { color: #c0392b; }
.msg.ai hr { border:none; border-top: 1px solid #eee; margin: 8px 0; }
.msg.ai table { font-size: 0.82rem; border-collapse: collapse; width: 100%; margin-top: 8px; }
.msg.ai th,.msg.ai td { border: 1px solid #ddd; padding: 5px 8px; }
.msg.ai th { background: #f0f4ff; }

/* å…¥åŠ›ã‚¨ãƒªã‚¢ */
.chat-input-area {
    display: flex;
    gap: 8px;
    padding: 12px 14px;
    border-top: 1px solid #f0f0f0;
    flex-shrink: 0;
    background: #fff;
}
.chat-textarea {
    flex-grow: 1;
    resize: none;
    height: 52px;
    padding: 10px 14px;
    border: 2px solid #e0e7ff;
    border-radius: 12px;
    font-family: inherit;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
}
.chat-textarea:focus { border-color: #667eea; }
.send-btn {
    width: 52px;
    height: 52px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1.4rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.send-btn:hover { opacity: 0.88; transform: scale(1.05); }
.send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‰ãƒƒãƒˆ */
.typing-dots { display: flex; gap: 4px; align-items: center; padding: 4px 2px; }
.typing-dots span {
    width: 7px; height: 7px;
    background: #bbb;
    border-radius: 50%;
    animation: dot-bounce 1.2s infinite;
}
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dot-bounce { 0%,80%,100%{transform:scale(0.8);opacity:0.5} 40%{transform:scale(1.2);opacity:1} }

/* ãƒãƒ£ãƒ¼ãƒˆãƒ‘ãƒãƒ« */
.chart-box {
    background: #fff;
    border-radius: 14px;
    padding: 18px 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
}
.chart-box h3 { font-size: 0.9rem; font-weight: 700; color: #444; margin-bottom: 12px; }

/* Toasté€šçŸ¥ */
.toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    color: white;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 9999;
    opacity: 0;
    transform: translateY(12px);
    transition: all 0.3s;
    pointer-events: none;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast.success { background: #28a745; }
.toast.error   { background: #dc3545; }
.toast.info    { background: #17a2b8; }

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 1100px) {
    .dashboard { grid-template-columns: 1fr; }
    .kpi-row   { grid-template-columns: repeat(2, 1fr); }
    .sidebar   { min-height: 600px; }
}
@media (max-width: 600px) {
    body { padding: 10px; }
    .kpi-row { grid-template-columns: 1fr 1fr; }
    .nav-btn.left { left: 10px; font-size: 0.78rem; padding: 6px 12px; }
    .nav-btn.right { right: 10px; font-size: 0.78rem; padding: 6px 12px; }
}
</style>
</head>
<body>
<div class="container">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <a href="/admin.html" class="nav-btn left">â¬… ç®¡ç†ç”»é¢</a>
        <h1>ğŸ“Š çµ±è¨ˆãƒ»æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</h1>
        <p>å­¦ç”Ÿã®å£°ã®åˆ†æ &amp; AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®æ”¹å–„ç›¸è«‡</p>
        <a href="/logout" class="nav-btn right">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æœ¬ä½“ -->
    <div class="dashboard">

        <!-- å·¦: KPI + ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="main-area">

            <!-- KPI -->
            <div class="kpi-row">
                <div class="kpi-card">
                    <h3>ğŸ“ ç·ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
                    <div class="val" id="kpiTotal">â€”</div>
                    <div class="sub">å…¨æœŸé–“ã®ç´¯è¨ˆ</div>
                </div>
                <div class="kpi-card green">
                    <h3>ğŸ‘ é«˜è©•ä¾¡ç‡</h3>
                    <div class="val" id="kpiGoodRate">â€”</div>
                    <div class="sub" id="kpiGoodSub">Good: 0 / Bad: 0</div>
                </div>
                <div class="kpi-card blue">
                    <h3>ğŸ“… ä»Šé€±ã®åˆ©ç”¨</h3>
                    <div class="val" id="kpiWeekly">â€”</div>
                    <div class="sub">éå»7æ—¥é–“</div>
                </div>
                <div class="kpi-card orange">
                    <h3>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°</h3>
                    <div class="val" id="kpiLogs">â€”</div>
                    <div class="sub" id="kpiLogsSub">ãƒ™ã‚¯ãƒˆãƒ«åŒ–æ¸ˆã¿: â€”</div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="table-box">
                <div class="table-header">
                    <h2>ğŸ“‹ æœ€æ–°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å±¥æ­´</h2>
                    <button class="refresh-btn" onclick="fetchData()">ğŸ”„ æ›´æ–°</button>
                </div>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:130px">æ—¥æ™‚</th>
                                <th style="width:90px">è©•ä¾¡</th>
                                <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="3" style="text-align:center;padding:24px;color:#aaa">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div><!-- /main-area -->

        <!-- å³: AIç›¸è«‡ -->
        <div class="sidebar">

            <!-- ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="vec-status-card">
                <h3>ğŸ”¢ ãƒ™ã‚¯ãƒˆãƒ«DB ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>

                <div class="vec-row">
                    <span class="label">ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°</span>
                    <span class="nums" id="vecLogsNum">â€” / â€”</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="vecLogsBar" style="width:0%"></div>
                </div>

                <div class="vec-row" style="margin-top:10px">
                    <span class="label">æ„è¦‹ãƒ»è¦æœ›</span>
                    <span class="nums" id="vecCmNum">â€” / â€”</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="vecCmBar" style="width:0%"></div>
                </div>

                <div class="vec-actions">
                    <button class="vec-btn primary" id="vecBothBtn" onclick="runVectorize('both')">
                        âš¡ æœªå‡¦ç†ã‚’ä¸€æ‹¬ãƒ™ã‚¯ãƒˆãƒ«åŒ–
                    </button>
                    <button class="vec-btn secondary" onclick="fetchVecStatus()">
                        ğŸ”„ çŠ¶æ…‹ç¢ºèª
                    </button>
                </div>
            </div>

            <!-- AIç›¸è«‡ãƒãƒ£ãƒƒãƒˆ -->
            <div class="chat-panel">
                <div class="chat-panel-header">
                    <h3>ğŸ¤– AI æ¥­å‹™æ”¹å–„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</h3>
                    <p>è“„ç©ã•ã‚ŒãŸå­¦ç”Ÿã¨ã®ã‚„ã‚Šã¨ã‚Šã‚’ã‚‚ã¨ã«ã€æ”¹å–„ææ¡ˆãƒ»å‹•å‘åˆ†æã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™</p>
                </div>

                <div class="example-queries">
                    <p>ğŸ’¡ ã“ã‚“ãªè³ªå•ãŒã§ãã¾ã™</p>
                    <div class="ex-chips">
                        <span class="ex-chip" onclick="setQuery('æœ€è¿‘ã®å­¦ç”ŸãŒå›°ã£ã¦ã„ã‚‹ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„')">æœ€è¿‘ã®å­¦ç”Ÿã®å›°ã‚Šã”ã¨</span>
                        <span class="ex-chip" onclick="setQuery('å±¥ä¿®ç™»éŒ²ã«é–¢ã™ã‚‹è³ªå•ã®å‚¾å‘ã‚’åˆ†æã—ã¦ãã ã•ã„')">å±¥ä¿®ç™»éŒ²ã®å‚¾å‘</span>
                        <span class="ex-chip" onclick="setQuery('FAQã«è¿½åŠ ã™ã¹ãé …ç›®ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ')">FAQæ”¹å–„æ¡ˆ</span>
                        <span class="ex-chip" onclick="setQuery('å­¦ç”Ÿã®æ„è¦‹ãƒ»è¦æœ›ã§å¤šã„ã‚‚ã®ã¯ä½•ã§ã™ã‹ï¼Ÿ')">æ„è¦‹ãƒ»è¦æœ›ã®å‚¾å‘</span>
                        <span class="ex-chip" onclick="setQuery('AIãŒå›ç­”ã§ãã¦ã„ãªã„è³ªå•ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ•™ãˆã¦ãã ã•ã„')">æœªè§£æ±ºã®è³ªå•</span>
                    </div>
                </div>

                <div class="chat-history" id="chatHistory">
                    <div class="msg ai">
                        ã“ã‚“ã«ã¡ã¯ã€‚å­¦ç”Ÿå¯¾å¿œæ”¹å–„ã®ã‚µãƒãƒ¼ãƒˆã‚’ã—ã¾ã™ã€‚<br><br>
                        ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚„å­¦ç”Ÿã®æ„è¦‹ãƒ»è¦æœ›ã‚’<strong>ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢</strong>ã—ã¦ã€
                        é–¢é€£ã™ã‚‹æƒ…å ±ã ã‘ã‚’æŠ½å‡ºã—ã¦åˆ†æã—ã¾ã™ã€‚<br><br>
                        å·¦ä¸Šã®ã€Œãƒ™ã‚¯ãƒˆãƒ«åŒ–ã€ãƒœã‚¿ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã‹ã‚‰ã€
                        ãŠæ°—è»½ã«è³ªå•ã—ã¦ãã ã•ã„ï¼
                    </div>
                </div>

                <div class="chat-input-area">
                    <textarea
                        id="queryInput"
                        class="chat-textarea"
                        placeholder="è³ªå•ã‚’å…¥åŠ›ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰"
                        onkeydown="handleKey(event)"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendQuery()" title="é€ä¿¡">
                        â¤
                    </button>
                </div>
            </div><!-- /chat-panel -->

            <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="chart-box">
                <h3>ğŸ“ˆ è©•ä¾¡ã®å†…è¨³</h3>
                <canvas id="ratingChart" height="160"></canvas>
            </div>

        </div><!-- /sidebar -->
    </div><!-- /dashboard -->
</div><!-- /container -->

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ==================================================
// è¨­å®š
// ==================================================
marked.setOptions({ breaks: true, gfm: true });
let chartInstance = null;

// ==================================================
// Toast é€šçŸ¥
// ==================================================
function showToast(msg, type = 'info', duration = 3500) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    setTimeout(() => { t.classList.remove('show'); }, duration);
}

// ==================================================
// 1. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—
// ==================================================
async function fetchData() {
    try {
        const res = await fetch('/api/admin/stats/data');
        if (!res.ok) {
            if (res.status === 401 || res.status === 403) { location.href = '/login'; return; }
            throw new Error(res.statusText);
        }
        const data = await res.json();
        renderDashboard(data);
    } catch (e) {
    showToast('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: ' + e.message, 'error');
    
    // å®‰å…¨ãªDOMæ“ä½œã«ã‚ˆã‚‹æ›¸ãæ›ãˆ
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢

    const tr = document.createElement('tr');
    const td = document.createElement('td');
    
    td.colSpan = 3;
    td.style.textAlign = 'center';
    td.style.color = '#dc3545';
    td.style.padding = '20px';
    td.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + e.message; // ã€é‡è¦ã€‘textContentã‚’ä½¿ã†ã“ã¨ã§XSSã‚’é˜²ã
    
    tr.appendChild(td);
    tbody.appendChild(tr);
}
}

function renderDashboard(data) {
    const total  = data.length;
    const good   = data.filter(i => i.rating === 'good').length;
    const bad    = data.filter(i => i.rating === 'bad').length;
    const rate   = total > 0 ? Math.round(good / total * 100) : 0;
    const week   = new Date(); week.setDate(week.getDate() - 7);
    const weekly = data.filter(i => new Date(i.created_at) > week).length;

    document.getElementById('kpiTotal').textContent    = total + 'ä»¶';
    document.getElementById('kpiGoodRate').textContent = rate + '%';
    document.getElementById('kpiGoodSub').textContent  = `Good: ${good} / Bad: ${bad}`;
    document.getElementById('kpiWeekly').textContent   = weekly + 'ä»¶';

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;color:#aaa">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
    } else {
        data.forEach(item => {
            const tr = document.createElement('tr');
            const date = new Date(item.created_at).toLocaleString('ja-JP', { dateStyle: 'short', timeStyle: 'short' });
            const ratingBadge = item.rating === 'good'
                ? '<span class="badge good">ğŸ‘ Good</span>'
                : '<span class="badge bad">ğŸ‘ Bad</span>';

            const tdDate   = document.createElement('td');
            tdDate.style.color = '#999';
            tdDate.style.fontSize = '0.82rem';
            tdDate.style.whiteSpace = 'nowrap';
            tdDate.textContent = date;

            const tdRating = document.createElement('td');
            tdRating.innerHTML = ratingBadge; // ãƒãƒƒã‚¸ã®ã¿ï¼ˆå›ºå®šæ–‡å­—åˆ—ï¼‰

            const tdComment = document.createElement('td');
            tdComment.textContent = item.comment || item.content || 'ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ï¼‰';

            tr.appendChild(tdDate);
            tr.appendChild(tdRating);
            tr.appendChild(tdComment);
            tbody.appendChild(tr);
        });
    }

    renderChart(good, bad);
}

function renderChart(good, bad) {
    const ctx = document.getElementById('ratingChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Goodï¼ˆé«˜è©•ä¾¡ï¼‰', 'Badï¼ˆä½è©•ä¾¡ï¼‰'],
            datasets: [{
                data: [good, bad],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 0,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { font: { size: 12 } } } },
            cutout: '65%',
        }
    });
}

// ==================================================
// 2. ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
// ==================================================
async function fetchVecStatus() {
    try {
        const res = await fetch('/api/admin/stats/vectorize/status');
        if (!res.ok) throw new Error(res.statusText);
        const d = await res.json();

        const logs = d.chat_logs;
        const cm   = d.anonymous_comments;

        // KPI
        document.getElementById('kpiLogs').textContent    = logs.total + 'ä»¶';
        document.getElementById('kpiLogsSub').textContent = `ãƒ™ã‚¯ãƒˆãƒ«åŒ–æ¸ˆã¿: ${logs.vectorized}ä»¶`;

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰
        document.getElementById('vecLogsNum').textContent = `${logs.vectorized} / ${logs.total}`;
        document.getElementById('vecCmNum').textContent   = `${cm.vectorized} / ${cm.total}`;

        const logsPct = logs.total > 0 ? Math.round(logs.vectorized / logs.total * 100) : 0;
        const cmPct   = cm.total   > 0 ? Math.round(cm.vectorized   / cm.total   * 100) : 0;
        document.getElementById('vecLogsBar').style.width = logsPct + '%';
        document.getElementById('vecCmBar').style.width   = cmPct + '%';

    } catch (e) {
        console.warn('vectorize status error:', e);
    }
}

// ==================================================
// 3. ä¸€æ‹¬ãƒ™ã‚¯ãƒˆãƒ«åŒ–
// ==================================================
async function runVectorize(target) {
    const btn = document.getElementById('vecBothBtn');
    btn.disabled = true;
    btn.textContent = 'å‡¦ç†ä¸­...';
    showToast('ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚', 'info', 8000);

    try {
        const res = await fetch('/api/admin/stats/vectorize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target, limit: 200 }),
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();

        // çµæœã‚µãƒãƒªãƒ¼ã‚’Toastã§è¡¨ç¤º
        let msg = 'âœ… ãƒ™ã‚¯ãƒˆãƒ«åŒ–å®Œäº† | ';
        if (data.results.chat_logs) {
            const r = data.results.chat_logs;
            msg += `ãƒ­ã‚°: ${r.succeeded}ä»¶æˆåŠŸ `;
        }
        if (data.results.anonymous_comments) {
            const r = data.results.anonymous_comments;
            msg += `æ„è¦‹: ${r.succeeded}ä»¶æˆåŠŸ`;
        }
        showToast(msg, 'success', 5000);
        await fetchVecStatus();
    } catch (e) {
        showToast('ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'âš¡ æœªå‡¦ç†ã‚’ä¸€æ‹¬ãƒ™ã‚¯ãƒˆãƒ«åŒ–';
    }
}

// ==================================================
// 4. AIç›¸è«‡ãƒãƒ£ãƒƒãƒˆ
// ==================================================
function setQuery(text) {
    document.getElementById('queryInput').value = text;
    document.getElementById('queryInput').focus();
}

function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendQuery();
    }
}

async function sendQuery() {
    const input  = document.getElementById('queryInput');
    const btn    = document.getElementById('sendBtn');
    const history = document.getElementById('chatHistory');
    const query  = input.value.trim();
    if (!query) return;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
    appendMsg('user', query);
    input.value = '';
    btn.disabled = true;

    // AIãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ–ãƒ«
    const aiEl = document.createElement('div');
    aiEl.className = 'msg ai';
    aiEl.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
    history.appendChild(aiEl);
    history.scrollTop = history.scrollHeight;

    let aiText = '';

    try {
        const res = await fetch('/api/admin/stats/chat_analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, target_period_days: 30 }),
        });

        if (!res.ok) throw new Error(`API Error: ${res.statusText}`);

        const reader  = res.body.getReader();
        const decoder = new TextDecoder();
        let isFirst   = true;

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            aiText += chunk;

            if (isFirst) {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‰ãƒƒãƒˆã‚’æ¶ˆã—ã¦ãƒ†ã‚­ã‚¹ãƒˆé–‹å§‹
                aiEl.innerHTML = '';
                isFirst = false;
            }

            // Markdown + DOMPurify ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const rawHtml  = marked.parse(aiText);
            const safeHtml = DOMPurify.sanitize(rawHtml, {
                ALLOWED_TAGS: ['p','br','strong','em','ul','ol','li','h1','h2','h3','h4',
                               'blockquote','code','pre','hr','table','thead','tbody','tr','th','td','a'],
                ALLOWED_ATTR: ['href','target','rel'],
            });
            aiEl.innerHTML = safeHtml;
            history.scrollTop = history.scrollHeight;
        }

        if (isFirst) {
            // ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹
            aiEl.textContent = 'ï¼ˆå›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰';
        }

    } catch (e) {
        console.error(e);
        
        // å®‰å…¨ãªDOMæ“ä½œã«ã‚ˆã‚‹æ›¸ãæ›ãˆ
        aiEl.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢
        
        const errSpan = document.createElement('span');
        errSpan.style.color = '#dc3545';
        errSpan.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + e.message; // ã€é‡è¦ã€‘textContentã‚’ä½¿ã†ã“ã¨ã§XSSã‚’é˜²ã
        
        aiEl.appendChild(errSpan);

    } finally {
        // â–¼ ã“ã“ãŒä¸è¶³ã—ã¦ã„ã¾ã—ãŸ â–¼
        const btn = document.getElementById('sendBtn'); // å¿µã®ãŸã‚å†å–å¾—ã€ã‚ã‚‹ã„ã¯ã‚¹ã‚³ãƒ¼ãƒ—å†…ã®btnã‚’ä½¿ç”¨
        if(btn) btn.disabled = false; // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å†åº¦æŠ¼ã›ã‚‹ã‚ˆã†ã«æˆ»ã™
    } // â† finallyãƒ–ãƒ­ãƒƒã‚¯ã‚’é–‰ã˜ã‚‹

} // â† sendQueryé–¢æ•°å…¨ä½“ã‚’é–‰ã˜ã‚‹


// â–¼ ã“ã“ã‹ã‚‰æ¬¡ã®é–¢æ•°å®šç¾© â–¼
function appendMsg(role, text) {
    const history = document.getElementById('chatHistory');
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.textContent = text; // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¯ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å®‰å…¨ã«è¡¨ç¤º
    history.appendChild(div);
    history.scrollTop = history.scrollHeight;
}

// ==================================================
// åˆæœŸåŒ–
// ==================================================
(async () => {
    await fetchData();
    await fetchVecStatus();
})();
</script>
</body>
</html>