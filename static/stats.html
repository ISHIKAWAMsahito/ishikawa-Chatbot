<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI chatbot systemã€çµ±è¨ˆãƒ»åˆ†æã€‘</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
<link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/admin.html" class="nav-btn admin-link-btn">â¬… ç®¡ç†ç”»é¢ã¸æˆ»ã‚‹</a>
            <a href="/logout" class="nav-btn logout-btn">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            <h1>ğŸ“Š çµ±è¨ˆãƒ»åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨å‚¾å‘åˆ†æ</p>
        </div>

        <div class="dashboard-content">
            <div class="main-area">
                <div class="stats-cards">
                    <div class="card">
                        <h3>ğŸ“ ç·ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ•°</h3>
                        <div class="value" id="totalCount">-</div>
                        <div class="sub">å…¨æœŸé–“ã®ç´¯è¨ˆ</div>
                    </div>
                    <div class="card">
                        <h3>ğŸ‘ é«˜è©•ä¾¡ç‡</h3>
                        <div class="value" id="goodRate">-</div>
                        <div class="sub" id="goodCountSub">Good: 0 / Bad: 0</div>
                    </div>
                    <div class="card">
                        <h3>ğŸ“… ä»Šé€±ã®åˆ©ç”¨</h3>
                        <div class="value" id="weeklyCount">-</div>
                        <div class="sub">éå»7æ—¥é–“</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="section-header">
                        <h2>ğŸ“‹ æœ€æ–°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å±¥æ­´</h2>
                        <button class="small-btn primary" onclick="fetchData()" style="padding:6px 12px; cursor:pointer;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th class="col-date">æ—¥æ™‚</th>
                                <th class="col-rating">è©•ä¾¡</th>
                                <th class="col-log">ä¼šè©±ãƒ­ã‚° / ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr><td colspan="3" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel-box">
                    <h3>ğŸ“ˆ è©•ä¾¡ã®å‰²åˆ</h3>
                    <canvas id="ratingChart"></canvas>
                </div>

                <div class="panel-box">
                    <h3>ğŸ§  AIå‚¾å‘åˆ†æ</h3>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">
                        ä¼šè©±ãƒ­ã‚°ã®å†…å®¹ã‚’AIãŒèª­ã¿å–ã‚Šã€è³ªå•ã®å‚¾å‘ã‚„æ”¹å–„ç‚¹ã‚’åˆ†æã—ã¾ã™ã€‚
                    </p>
                    <button class="analyze-btn" id="analyzeBtn" onclick="runAiAnalysis()">
                        <span>âœ¨ åˆ†æã‚’å®Ÿè¡Œã™ã‚‹</span>
                    </button>
                    <div id="aiAnalysisResult" class="ai-result">
                        ã“ã“ã«åˆ†æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const { createClient } = supabase;
    let supabaseClient = null;
    let chartInstance = null;
    let currentData = [];

    // SupabaseåˆæœŸåŒ–
    async function initializeSupabase() {
        try {
            const response = await fetch('/api/client/chat/config');
            if (!response.ok) return;
            const config = await response.json();
            if (config.supabase_url && config.supabase_anon_key) {
                supabaseClient = createClient(config.supabase_url, config.supabase_anon_key);
                console.log('Supabase initialized');
                fetchData();
            }
        } catch (error) {
            console.error("Supabase init error:", error);
        }
    }

    // ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
    async function fetchData() {
        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ä½¿ã‚ãšã€è‡ªã‚µãƒ¼ãƒãƒ¼ã®APIã‚’å©ã
        try {
            const response = await fetch('/api/admin/stats/data');
            
            if (!response.ok) {
                // èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ï¼‰ãªã©ã®å ´åˆ
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login'; // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é£›ã°ã™
                    return;
                }
                throw new Error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }

            const data = await response.json();
            currentData = data;
            renderDashboard(data);

        } catch (err) {
            console.error("Fetch error:", err);
            document.getElementById('dataTableBody').innerHTML = 
                `<tr><td colspan="3" style="color:red; text-align:center;">ã‚¨ãƒ©ãƒ¼: ${err.message}</td></tr>`;
        }
    }

    // ç”»é¢æç”»
    function renderDashboard(data) {
        // KPIè¨ˆç®—
        const total = data.length;
        const good = data.filter(i => i.rating === 'good').length;
        const bad = data.filter(i => i.rating === 'bad').length;
        const rate = total > 0 ? Math.round((good / total) * 100) : 0;

        // ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const weekly = data.filter(i => new Date(i.created_at) > oneWeekAgo).length;

        document.getElementById('totalCount').textContent = total + "ä»¶"; 
        document.getElementById('goodRate').textContent = rate + "%";
        document.getElementById('goodCountSub').textContent = `Good: ${good} / Bad: ${bad}`;
        document.getElementById('weeklyCount').textContent = weekly + "ä»¶";

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        } else {
            data.forEach(item => {
                const tr = document.createElement('tr');
                const date = new Date(item.created_at).toLocaleString('ja-JP');
                const ratingIcon = item.rating === 'good' ? '<span style="color:#28a745">ğŸ‘ Good</span>' : '<span style="color:#dc3545">ğŸ‘ Bad</span>';
                
                // commentã‚«ãƒ©ãƒ ã®å†…å®¹ã‚’è¡¨ç¤ºï¼ˆã“ã‚ŒãŒä¼šè©±ãƒ­ã‚°ï¼‰
                const logContent = item.comment || "(ãƒ­ã‚°ãªã—)";
                
                tr.innerHTML = `
                    <td class="col-date">${date}</td>
                    <td class="col-rating">${ratingIcon}</td>
                    <td class="col-log">${escapeHtml(logContent)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ã‚°ãƒ©ãƒ•æç”»
        renderChart(good, bad);
    }

    function renderChart(good, bad) {
        const ctx = document.getElementById('ratingChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Good (é«˜è©•ä¾¡)', 'Bad (ä½è©•ä¾¡)'],
                datasets: [{
                    data: [good, bad],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // AIåˆ†æã®å®Ÿè¡Œ
    async function runAiAnalysis() {
        const btn = document.getElementById('analyzeBtn');
        const resultDiv = document.getElementById('aiAnalysisResult');
        
        if (currentData.length === 0) {
            resultDiv.textContent = "åˆ†æã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span>â³ åˆ†æä¸­...</span>';
        resultDiv.textContent = "GeminiãŒãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™...";

        // åˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆ
        const logsText = currentData.map(d => {
            // commentã‚«ãƒ©ãƒ ã«ä¼šè©±ãƒ­ã‚°ãŒå…¥ã£ã¦ã„ã‚‹ã“ã¨ã‚’æ˜ç¤ºã—ã¦æ¸¡ã™
            return `- è©•ä¾¡:${d.rating} | ãƒ­ã‚°å†…å®¹:${d.comment}`;
        }).join("\n");

        const prompt = `
ã‚ãªãŸã¯ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®ç®¡ç†è€…ç”¨åˆ†æAIã§ã™ã€‚
ä»¥ä¸‹ã®ã€Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å±¥æ­´ï¼ˆæœ€æ–°${currentData.length}ä»¶ï¼‰ã€ã‚’åˆ†æã—ã€ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
å„ãƒ­ã‚°ã®ã€Œãƒ­ã‚°å†…å®¹ã€ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã¨AIã®å›ç­”ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

å†…å®¹ã¯ä»¥ä¸‹ã®3ç‚¹ã‚’å«ã‚ã¦ãã ã•ã„ï¼ˆMarkdownå½¢å¼ï¼‰ï¼š
1. **è³ªå•ãƒˆãƒ¬ãƒ³ãƒ‰**: å­¦ç”Ÿã¯ã©ã®ã‚ˆã†ãªã“ã¨ï¼ˆä¾‹ï¼šå±¥ä¿®ç™»éŒ²ã€æ–½è¨­åˆ©ç”¨ã€ã‚µãƒ¼ã‚¯ãƒ«ï¼‰ã«ã¤ã„ã¦è³ªå•ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
2. **è©•ä¾¡åˆ†æ**: Badè©•ä¾¡ãŒã¤ã„ã¦ã„ã‚‹å ´åˆã€ã©ã®ã‚ˆã†ãªã‚„ã‚Šå–ã‚Šã§ç™ºç”Ÿã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
3. **æ”¹å–„ææ¡ˆ**: å›ç­”ç²¾åº¦ã‚’ä¸Šã’ã‚‹ãŸã‚ã«è¿½åŠ ã™ã¹ãæƒ…å ±ã‚„æ”¹å–„ç‚¹ã€‚

ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å±¥æ­´ã€‘
${logsText}
        `;

        try {
        // â˜…ã“ã“ã‚’ä¿®æ­£ï¼ URLã®æœ«å°¾ã‚’ /analyze ã«ã™ã‚‹
        const response = await fetch('/api/admin/chat/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}) 
        });

            if (!response.ok) throw new Error("API Error");

            // ã‚¹ãƒˆãƒªãƒ¼ãƒ èª­ã¿è¾¼ã¿
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(line.substring(6));
                            if (json.content) fullText += json.content;
                        } catch(e){}
                    }
                }
            }

            resultDiv.innerHTML = marked.parse(fullText);

        } catch (error) {
            console.error(error);
            resultDiv.textContent = "åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span>âœ¨ åˆ†æã‚’å®Ÿè¡Œã™ã‚‹</span>';
        }
    }

    function escapeHtml(str) {
        if(!str) return '';
        return str.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            }[m];
        });
    }

    // å®Ÿè¡Œ
    initializeSupabase();
    </script>
</body>
</html>