<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DBç®¡ç†ç”»é¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #222;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2rem; margin-bottom: 8px; }
        .header p { opacity: 0.95; }

        /* --- ã‚¿ãƒ– --- */
        .tabs {
            display: flex;
            background: #f1f3f5;
            padding: 10px 20px 0 20px;
        }
        .tab-button {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #868e96;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
        }
        .tab-button.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .stats { padding: 20px; background: #e3f2fd; border-radius: 10px; margin: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 1.6rem; font-weight: 700; color: #4facfe; }
        .stat-label { color: #6c757d; font-size: 0.9rem; }

        .controls {
            padding: 18px 20px;
            background: #f8f9fa;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }
        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 15px;
            background: white;
        }
        .category-filter {
            padding: 8px 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            min-width: 180px;
        }
        .btn {
            padding: 10px 18px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform .18s ease, box-shadow .18s ease;
        }
        .btn.secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
        .btn.success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        .btn.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #333; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(79,172,254,0.15); }
        .btn:disabled { background: #ced4da; cursor: not-allowed; transform: none; box-shadow: none; }

        .table-container { 
            padding: 20px; 
            overflow-x: auto; 
            padding-bottom: 80px; 
            position: relative;
        }
        table { width: 100%; border-collapse: collapse; background: white; }
        #documentsTable, #qaTable { display: none; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; vertical-align: top; }
        th { background: #f8f9fa; font-weight: 600; color: #495057; position: sticky; top: 0; z-index: 1; }
        tr:hover { background: #f1f3f5; }

        .content-preview {
            max-width: 420px;
            max-height: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.95rem;
            color: #333;
        }
        .metadata { font-size: 0.85rem; color: #6c757d; }
        .embedding-status { font-size: 0.85rem; padding: 3px 6px; border-radius: 4px; display: inline-block; }
        .embedding-status.ok { background: #d4edda; color: #155724; }
        .embedding-status.ng { background: #f8d7da; color: #721c24; }

        .action-buttons { display:flex; gap:6px; }
        .action-btn { padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.86rem; }
        .action-btn.edit { background:#28a745; color:white; }
        .action-btn.delete { background:#dc3545; color:white; }
        .action-btn:hover { opacity:0.9; transform: translateY(-1px); }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display:none; position: fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.5); }
        .modal.show { display:flex; align-items:center; justify-content:center; }
        .modal-content {
            background:white; padding:28px; border-radius:12px; width: 92%; max-width:760px; max-height:86vh; overflow:auto;
        }
        .form-group { margin-bottom:16px; }
        .form-group label { display:block; margin-bottom:6px; font-weight:600; }
        .form-group input, .form-group textarea { width:100%; padding:10px; border:1px solid #dee2e6; border-radius:8px; font-family:inherit; }
        .form-group textarea { min-height:180px; resize:vertical; }

        #qaEditQuestion { min-height: 80px; }
        #qaEditAnswer { min-height: 120px; }

        .loading { text-align:center; padding:40px; color:#6c757d; }
        .sr-only { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0 0 0 0) !important; white-space: nowrap !important; border: 0 !important; }

        .pagination-controls {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            position: sticky;
            bottom: 0;
            z-index: 2;
        }
        .pagination-controls button {
            padding: 8px 14px;
            border: 1px solid #dee2e6;
            background: white;
            color: #4facfe;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .pagination-controls button:disabled {
            background: #f1f3f5;
            color: #adb5bd;
            cursor: not-allowed;
        }
        .pagination-controls span {
            font-weight: 600;
            color: #495057;
        }
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 920px) {
            .controls { gap:10px; padding:14px; }
            .content-preview { max-width: 260px; }
        }
        @media (max-width: 520px) {
            .controls { flex-direction: column; align-items: stretch; }
            .category-filter, .search-box, .btn { width: 100%; }
            th, td { font-size: 0.92rem; padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š DBç®¡ç†ç”»é¢</h1>
            <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨Q&Aã‚’ç®¡ç†</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('documents')">çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ (Documents)</button>
            <button class="tab-button" onclick="showTab('qa')">Q&A (Fallbacks)</button>
        </div>

        <div id="documents-view" class="tab-content active">
            <div class="stats">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCount">0</div>
                        <div class="stat-label">ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="categoryCount">0</div>
                        <div class="stat-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="selectedCount">0</div>
                        <div class="stat-label">è¡¨ç¤ºä¸­</div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <input type="text" id="searchInput" class="search-box" placeholder="æ¤œç´¢ï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€ã‚½ãƒ¼ã‚¹ï¼‰">
                <label for="categoryFilter" class="sr-only">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§çµã‚Šè¾¼ã‚€</label>
                <select id="categoryFilter" class="category-filter" aria-label="ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§çµã‚Šè¾¼ã‚€">
                    <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
                </select>
                <button class="btn" onclick="currentPage = 1; loadDocuments();">ğŸ”„ æ›´æ–°</button>
                <button class="btn secondary" onclick="window.location.href='/admin'">â† ç®¡ç†ç”»é¢ã«æˆ»ã‚‹</button>
            </div>

            <div class="table-container">
                <div id="loadingIndicator" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                <table id="documentsTable" aria-live="polite">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                            <th scope="col">ã‚½ãƒ¼ã‚¹</th>
                            <th scope="col">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</th>
                            <th scope="col">ä½œæˆæ—¥æ™‚</th>
                            <th scope="col">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="documentsBody"></tbody>
                </table>
                <div id="paginationControls" class="pagination-controls"></div>
            </div>
        </div> 
        
        <div id="qa-view" class="tab-content">
            <div class="stats">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="qaTotalCount">0</div>
                        <div class="stat-label">ç·Q&Aæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="qaVectorizedCount">0</div>
                        <div class="stat-label">ãƒ™ã‚¯ãƒˆãƒ«åŒ–æ¸ˆã¿</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="qaMissingCount">0</div>
                        <div class="stat-label">ãƒ™ã‚¯ãƒˆãƒ«æœªå‡¦ç†</div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn success" onclick="openNewQAModal()">ï¼‹ æ–°è¦Q&Aã‚’è¿½åŠ </button>
                <button class="btn warning" id="vectorizeAllBtn" onclick="vectorizeAllMissing()">
                    âš¡ ãƒ™ã‚¯ãƒˆãƒ«æœªå‡¦ç†ã‚’ã™ã¹ã¦å®Ÿè¡Œ
                </button>
                 <button class="btn secondary" onclick="window.location.href='/admin'">â† ç®¡ç†ç”»é¢ã«æˆ»ã‚‹</button>
            </div>

             <div class="table-container">
                <div id="qaLoadingIndicator" class="loading">Q&Aãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                <table id="qaTable" aria-live="polite">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                            <th scope="col">è³ªå• (Question) / å›ç­” (Answer)</th>
                            <th scope="col">ãƒ™ã‚¯ãƒˆãƒ«</th>
                            <th scope="col">ä½œæˆæ—¥æ™‚</th>
                            <th scope="col">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="qaBody"></tbody>
                </table>
            </div>
        </div> 
    </div> 

    <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="modal-content">
            <h2 id="editModalTitle">ãƒ¬ã‚³ãƒ¼ãƒ‰ç·¨é›† (Document)</h2>
            <div class="form-group">
                <label for="editId">ID:</label>
                <input type="text" id="editId" readonly>
            </div>
            <div class="form-group">
                <label for="editCategory">ã‚«ãƒ†ã‚´ãƒªãƒ¼:</label>
                <input type="text" id="editCategory">
            </div>
            <div class="form-group">
                <label for="editSource">ã‚½ãƒ¼ã‚¹:</label>
                <input type="text" id="editSource">
            </div>
            <div class="form-group">
                <label for="editContent">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„:</label>
                <textarea id="editContent"></textarea>
            </div>
            <div class="action-buttons">
                <button class="btn secondary" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" onclick="saveDocument()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="qaEditModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="qaEditModalTitle">
        <div class="modal-content">
            <h2 id="qaEditModalTitle">Q&Aç·¨é›†</h2>
            <input type="hidden" id="qaEditId">

            <div class="form-group">
                <label for="qaEditCategory">ã‚«ãƒ†ã‚´ãƒªãƒ¼:</label>
                <input type="text" id="qaEditCategory" placeholder="ä¾‹: æˆæ¥­, æ–½è¨­, ãã®ä»–">
                <small>â€»Q&Aã®åˆ†é¡ã«ä½¿ã„ã¾ã™ã€‚å¿…é ˆã§ã™ã€‚</small>
            </div>

            <div class="form-group">
                <label for="qaEditQuestion">è³ªå• (Question):</label>
                <textarea id="qaEditQuestion" placeholder="ä¾‹ï¼š å­¦ç”Ÿè¨¼ã‚’ãªãã—ã¾ã—ãŸ"></textarea>
                <small>â€»ã“ã®ã€Œè³ªå•ã€ãŒãƒ™ã‚¯ãƒˆãƒ«åŒ–ã•ã‚Œã€æ¤œç´¢å¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚</small>
            </div>
            <div class="form-group">
                <label for="qaEditAnswer">å›ç­” (Answer):</label>
                <textarea id="qaEditAnswer" placeholder="ä¾‹ï¼š å­¦ç”Ÿæ”¯æ´èª²ã§å†ç™ºè¡Œæ‰‹ç¶šã‚’ã—ã¦ãã ã•ã„..."></textarea>
                <small>â€»æ¤œç´¢ã«ãƒ’ãƒƒãƒˆã—ãŸæ™‚ã«ã€ã“ã®ã€Œå›ç­”ã€ãŒAIã®å›ç­”æ–‡ã«ãªã‚Šã¾ã™ã€‚</small>
            </div>
            
            <div class="action-buttons">
                <button class="btn secondary" onclick="closeQAModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" onclick="saveQA()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        const rowsPerPage = 100;
        let allQA = []; 
        let docCategories = new Set();
        let currentDocMetadata = {}; 

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`${tabName}-view`).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =============================================
        // [1] çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ (Documents) é–¢é€£
        // =============================================
        
        async function loadDocuments() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const table = document.getElementById('documentsTable');
            const paginationControls = document.getElementById('paginationControls');
            
            loadingIndicator.style.display = 'block';
            table.style.display = 'none';
            paginationControls.style.display = 'none';

            const searchTerm = document.getElementById('searchInput').value;
            const categoryFilter = document.getElementById('categoryFilter').value;

            // â˜…ä¿®æ­£: /api/admin/documents/all ã«å¤‰æ›´
            let url = `/api/admin/documents/all?page=${currentPage}&limit=${rowsPerPage}`;
            if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
            if (categoryFilter) url += `&category=${encodeURIComponent(categoryFilter)}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                if (docCategories.size === 0) {
                    await loadAllCategories();
                }

                displayDocuments(data.documents);
                updateDocStats(data.total, data.documents.length);
                renderPaginationControls(data.total); 

                loadingIndicator.style.display = 'none';
                table.style.display = 'table';
                if (data.total > rowsPerPage) { 
                    paginationControls.style.display = 'flex'; 
                }

            } catch (error) {
                console.error('Error loading documents:', error);
                // Snykå¯¾ç­– (CWE-79): innerHTML -> textContent
                loadingIndicator.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
        }
        
        async function loadAllCategories() {
             try {
                // å¿…è¦ã«å¿œã˜ã¦ã‚«ãƒ†ã‚´ãƒªå–å¾—APIã‚’å‘¼ã³å‡ºã™
             } catch (error) {
                 console.error('Error loading categories:', error);
             }
        }

        function displayDocuments(documents) {
            const tbody = document.getElementById('documentsBody');
            tbody.innerHTML = '';
            
            if (documents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color: #6c757d;">è©²å½“ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
                return;
            }

            documents.forEach(doc => { 
                const tr = document.createElement('tr');
                const created = doc.created_at ? new Date(doc.created_at).toLocaleString('ja-JP') : 'N/A';
                
                if (doc.metadata?.category && !docCategories.has(doc.metadata.category)) {
                    docCategories.add(doc.metadata.category);
                    const option = document.createElement('option');
                    option.value = doc.metadata.category;
                    option.textContent = doc.metadata.category;
                    document.getElementById('categoryFilter').appendChild(option);
                }

                tr.innerHTML = `
                    <td>${doc.id}</td>
                    <td><span class="metadata">${doc.metadata?.category || 'ãã®ä»–'}</span></td>
                    <td><span class="metadata">${escapeHtml(doc.metadata?.source || 'N/A')}</span></td>
                    <td><div class="content-preview">${escapeHtml(doc.content || '')}</div></td>
                    <td><span class="metadata">${created}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editDocument(${doc.id})" aria-label="ç·¨é›†">ç·¨é›†</button>
                            <button class="action-btn delete" onclick="deleteDocument(${doc.id})" aria-label="å‰Šé™¤">å‰Šé™¤</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateDocStats(totalRecords, displayedCount) {
            document.getElementById('totalCount').textContent = totalRecords;
            document.getElementById('categoryCount').textContent = docCategories.size; 
            document.getElementById('selectedCount').textContent = displayedCount; 
        }

        function renderPaginationControls(totalRecords) {
            const paginationContainer = document.getElementById('paginationControls');
            paginationContainer.innerHTML = '';

            if (totalRecords <= rowsPerPage) {
                paginationContainer.style.display = 'none';
                return;
            }

            const totalPages = Math.ceil(totalRecords / rowsPerPage);

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Â« å‰ã¸';
            prevButton.disabled = (currentPage === 1);
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadDocuments();
                }
            };
            paginationContainer.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `${currentPage} / ${totalPages} ãƒšãƒ¼ã‚¸ (${totalRecords}ä»¶)`;
            paginationContainer.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.textContent = 'æ¬¡ã¸ Â»';
            nextButton.disabled = (currentPage === totalPages);
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadDocuments();
                }
            };
            paginationContainer.appendChild(nextButton);
        }

        async function editDocument(id) {
            try {
                // â˜…ä¿®æ­£: /api/admin/documents/... ã«å¤‰æ›´
                const response = await fetch(`/api/admin/documents/${id}`);
                if (!response.ok) throw new Error('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—');
                const doc = await response.json();
                
                document.getElementById('editId').value = doc.id;
                document.getElementById('editCategory').value = doc.metadata?.category || '';
                document.getElementById('editSource').value = doc.metadata?.source || '';
                document.getElementById('editContent').value = doc.content || '';
                
                currentDocMetadata = doc.metadata || {};
                
                document.getElementById('editModal').classList.add('show');
            } catch(error) {
                alert(error.message);
            }
        }

        function closeEditModal() { 
            document.getElementById('editModal').classList.remove('show');
            currentDocMetadata = {}; 
        }

        async function saveDocument() {
            const id = document.getElementById('editId').value;
            const category = document.getElementById('editCategory').value;
            const source = document.getElementById('editSource').value;
            const content = document.getElementById('editContent').value;
            try {
                const updatedMetadata = { 
                    ...currentDocMetadata,
                    category: category,    
                    source: source         
                };

                // â˜…ä¿®æ­£: /api/admin/documents/... ã«å¤‰æ›´
                const response = await fetch(`/api/admin/documents/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content, metadata: updatedMetadata })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                alert('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                closeEditModal();
                loadDocuments(); 
            } catch (error) {
                console.error('Error saving document:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function deleteDocument(id) {
            if (!confirm(`ID ${id} ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
            try {
                // â˜…ä¿®æ­£: /api/admin/documents/... ã«å¤‰æ›´
                const response = await fetch(`/api/admin/documents/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                alert('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                loadDocuments();
            } catch (error) {
                console.error('Error deleting document:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // =============================================
        // [2] Q&A (Fallbacks) é–¢é€£
        // =============================================
        async function loadQA() {
            const loadingIndicator = document.getElementById('qaLoadingIndicator');
            const table = document.getElementById('qaTable');
            loadingIndicator.style.display = 'block';
            table.style.display = 'none';
            try {
                // â˜…ä¿®æ­£: /api/admin/fallbacks ã«å¤‰æ›´
                const response = await fetch('/api/admin/fallbacks'); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                allQA = data.fallbacks || [];
                displayQA(allQA);
                updateQAStats();
                loadingIndicator.style.display = 'none';
                table.style.display = 'table';
            } catch (error) {
                console.error('Error loading Q&A:', error);
                // Snykå¯¾ç­– (CWE-79): innerHTML -> textContent
                loadingIndicator.textContent = 'Q&Aã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
        }

        function displayQA(qaList) {
            const tbody = document.getElementById('qaBody');
            tbody.innerHTML = '';
            qaList.forEach(qa => {
                const tr = document.createElement('tr');
                const created = qa.created_at ? new Date(qa.created_at).toLocaleString('ja-JP') : 'N/A';
                
                let embeddingStatus;
                if (qa.embedding && qa.embedding.length > 0) {
                     embeddingStatus = '<span class="embedding-status ok">OK</span>';
                } else if (allQA.length > 0 && typeof qa.embedding === 'undefined') {
                    embeddingStatus = '<span class="metadata">--</span>';
                } else {
                     embeddingStatus = '<span class="embedding-status ng">æœªå‡¦ç†</span>';
                }
                
                tr.innerHTML = `
                    <td>${qa.id}</td>
                    <td><span class="metadata">${escapeHtml(qa.category_name || 'æœªåˆ†é¡')}</span></td>
                    <td>
                        <div class="content-preview" style="font-weight: 600;">Q: ${escapeHtml(qa.question || '')}</div>
                        <div class="content-preview" style="opacity: 0.8; margin-top: 4px;">A: ${escapeHtml(qa.answer || '')}</div>
                    </td>
                    <td>${embeddingStatus}</td>
                    <td><span class="metadata">${created}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editQA(${qa.id})" aria-label="ç·¨é›†">ç·¨é›†</button>
                            <button class="action-btn delete" onclick="deleteQA(${qa.id})" aria-label="å‰Šé™¤">å‰Šé™¤</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateQAStats() {
            const total = allQA.length;
            const vectorized = allQA.filter(qa => qa.embedding && qa.embedding.length > 0).length;
            const missing = total - vectorized;
            
            document.getElementById('qaTotalCount').textContent = total;
            document.getElementById('qaVectorizedCount').textContent = vectorized;
            document.getElementById('qaMissingCount').textContent = missing;
            
            const vectorizeBtn = document.getElementById('vectorizeAllBtn');
            vectorizeBtn.disabled = (missing === 0);
            if (missing === 0) {
                vectorizeBtn.textContent = 'âš¡ ã™ã¹ã¦ãƒ™ã‚¯ãƒˆãƒ«åŒ–æ¸ˆã¿';
            } else {
                vectorizeBtn.textContent = `âš¡ ãƒ™ã‚¯ãƒˆãƒ«æœªå‡¦ç† (${missing}ä»¶) ã‚’ã™ã¹ã¦å®Ÿè¡Œ`;
            }
        }

        function openNewQAModal() {
            document.getElementById('qaEditId').value = '';
            document.getElementById('qaEditModalTitle').textContent = 'æ–°è¦Q&Aã‚’è¿½åŠ ';
            document.getElementById('qaEditCategory').value = '';
            document.getElementById('qaEditQuestion').value = '';
            document.getElementById('qaEditAnswer').value = '';
            document.getElementById('qaEditModal').classList.add('show');
        }

        function editQA(id) {
            const qa = allQA.find(q => q.id === id);
            if (!qa) return;
            document.getElementById('qaEditId').value = qa.id;
            document.getElementById('qaEditModalTitle').textContent = `Q&Aç·¨é›† (ID: ${qa.id})`;
            document.getElementById('qaEditCategory').value = qa.category_name || 'ãã®ä»–';
            document.getElementById('qaEditQuestion').value = qa.question || '';
            document.getElementById('qaEditAnswer').value = qa.answer || '';
            document.getElementById('qaEditModal').classList.add('show');
        }

        function closeQAModal() { document.getElementById('qaEditModal').classList.remove('show'); }

        async function saveQA() {
            const id = document.getElementById('qaEditId').value;
            const category = document.getElementById('qaEditCategory').value.trim();
            const question = document.getElementById('qaEditQuestion').value.trim();
            const answer = document.getElementById('qaEditAnswer').value.trim();

            if (!category || !question || !answer) {
                alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€è³ªå•ã€å›ç­”ã¯ã™ã¹ã¦å¿…é ˆã§ã™ã€‚');
                return;
            }
            
            const isNew = !id;
            // â˜…ä¿®æ­£: /api/admin/fallbacks ã«å¤‰æ›´
            const url = isNew ? '/api/admin/fallbacks' : `/api/admin/fallbacks/${id}`;
            const method = isNew ? 'POST' : 'PUT';

            const body = {
                question: question,
                answer: answer,
                category_name: category 
            };

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                alert(result.message);
                closeQAModal();
                loadQA(); 
                
            } catch (error) {
                console.error('Error saving Q&A:', error);
                alert('Q&Aã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function deleteQA(id) {
            if (!confirm(`ID ${id} ã®Q&Aã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
            try {
                // â˜…ä¿®æ­£: /api/admin/fallbacks/... ã«å¤‰æ›´
                const response = await fetch(`/api/admin/fallbacks/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                alert('Q&Aã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                loadQA(); 
            } catch (error) {
                console.error('Error deleting Q&A:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function vectorizeAllMissing() {
            const btn = document.getElementById('vectorizeAllBtn');
            const originalText = btn.textContent;
            if (!confirm('ãƒ™ã‚¯ãƒˆãƒ«ãŒæœªå‡¦ç†ã®Q&Aã‚’ã™ã¹ã¦å‡¦ç†ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ (ä»¶æ•°ã«ã‚ˆã‚Šæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™)')) return;

            btn.disabled = true;
            btn.textContent = 'å‡¦ç†ä¸­...';
            
            try {
                // â˜…ä¿®æ­£: /api/admin/fallbacks/vectorize-all ã«å¤‰æ›´
                const response = await fetch('/api/admin/fallbacks/vectorize-all', { method: 'POST' });
                if (!response.ok) {
                     const err = await response.json();
                    throw new Error(err.detail || `HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                alert(result.message);
                loadQA(); 
            } catch (error) {
                 console.error('Error vectorizing all:', error);
                alert('ãƒ™ã‚¯ãƒˆãƒ«åŒ–å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1; 
            loadDocuments();
        });
        document.getElementById('categoryFilter').addEventListener('change', () => {
            currentPage = 1; 
            loadDocuments();
        });

        document.getElementById('editModal').addEventListener('click', function(e){ if (e.target === this) closeEditModal(); });
        document.getElementById('qaEditModal').addEventListener('click', function(e){ if (e.target === this) closeQAModal(); });

        loadDocuments(); 
        loadQA(); 
    </script>
</body>
</html>